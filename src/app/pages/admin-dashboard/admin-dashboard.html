<div class="admin-card">
  <div class="header">
    <div>
      <p class="eyebrow">Admin</p>
      <h1>Product management</h1>
      <p class="lede">Manage catalog items and upload imagery stored in Supabase.</p>
    </div>
    <div class="header-actions">
      <button class="btn primary" type="button" (click)="openCreateModal()">Add product</button>
      <a class="btn ghost" routerLink="/">Back to catalog</a>
    </div>
  </div>

  @if (showForm) {
  <div class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>{{ editingSlug ? 'Edit product' : 'Create product' }}</h2>
        <button type="button" class="icon-btn" (click)="closeModal()">✕</button>
      </div>
      <form class="admin-form" (ngSubmit)="submit()">
        <div class="form-grid">
          <label class="field">
            <span class="field-label">Name</span>
            <div class="input-shell">
              <input type="text" name="name" [(ngModel)]="form.name" required />
            </div>
          </label>
          <label class="field">
            <span class="field-label">Brand</span>
            <div class="input-shell">
              <input type="text" name="brand" [(ngModel)]="form.brand" required />
            </div>
          </label>
          <label class="field">
            <span class="field-label">Category</span>
            <div class="input-shell">
              <input type="text" name="category" [(ngModel)]="form.category" required />
            </div>
          </label>
          <label class="field">
            <span class="field-label">Upload image</span>
            <div class="input-shell file-shell">
              <input
                type="file"
                accept="image/*"
                (change)="handleImageUpload($event)"
                [disabled]="uploadingImage"
              />
            </div>
            <small *ngIf="uploadingImage" class="upload-hint">Uploading image...</small>
            <small *ngIf="uploadedImageName && !uploadingImage" class="upload-success"
              >Uploaded: {{ uploadedImageName }}</small
            >
            <small *ngIf="uploadError" class="upload-error">{{ uploadError }}</small>
          </label>
        </div>

        <label class="field">
          <span class="field-label">Description</span>
          <div class="input-shell textarea-shell">
            <textarea
              rows="3"
              name="description"
              [(ngModel)]="form.description"
              placeholder="Short description"
            ></textarea>
          </div>
        </label>

        <div class="form-grid">
          <label class="field">
            <span class="field-label">Option label</span>
            <div class="input-shell">
              <input
                type="text"
                name="optionLabel"
                [(ngModel)]="form.optionLabel"
                placeholder="e.g., 500ml"
              />
            </div>
          </label>
          <label class="field">
            <span class="field-label">Min quantity</span>
            <div class="input-shell">
              <input type="number" name="optionMinQty" [(ngModel)]="form.optionMinQty" min="1" />
            </div>
          </label>
          <div class="field add-option">
            <span class="field-label">&nbsp;</span>
            <button class="btn ghost" type="button" (click)="addOption()">Add option</button>
          </div>
        </div>

        @if (form.options.length) {
        <div class="options-list">
          @for (opt of form.options; let i = $index; track i) {
          <div class="option-pill">
            <span>{{ opt.label }} · Min {{ opt.minQty }}</span>
            <button type="button" class="icon-btn" (click)="removeOption(i)">✕</button>
          </div>
          }
        </div>
        }

        <div class="actions">
          <button class="btn primary" type="submit" [disabled]="uploadingImage || saving">
            {{ editingSlug ? 'Update product' : 'Add product' }}
          </button>
          <button class="btn ghost" type="button" (click)="closeModal()">Cancel</button>
        </div>
        <div class="form-error" *ngIf="saveError">{{ saveError }}</div>
      </form>
    </div>
  </div>
  } @if (products().length) {
  <section class="product-list">
    <h2>Existing products</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Brand</th>
          <th>Category</th>
          <th>Options</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (product of products(); track product.slug) {
        <tr [class.editing]="editingSlug === product.slug">
          <td>{{ product.name }}</td>
          <td>{{ product.brand }}</td>
          <td>{{ product.category }}</td>
          <td>{{ product.options.length }}</td>
          <td class="table-actions">
            <button class="link-btn" type="button" (click)="startEdit(product)">Edit</button>
            <button class="link-btn danger" type="button" (click)="deleteProduct(product.slug)">
              Delete
            </button>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </section>
  }
</div>

@if (deletePending) {
  <div class="modal-backdrop">
    <div class="modal small">
      <div class="modal-header">
        <h3>Delete product</h3>
        <button type="button" class="icon-btn" (click)="cancelDelete()">✕</button>
      </div>
      <p>Are you sure you want to delete <strong>{{ deletePending.name }}</strong>?</p>
      <div class="actions">
        <button class="btn danger" type="button" (click)="confirmDelete()">Delete</button>
        <button class="btn ghost" type="button" (click)="cancelDelete()">Cancel</button>
      </div>
    </div>
  </div>
}
