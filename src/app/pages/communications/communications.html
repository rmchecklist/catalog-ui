<div class="admin-layout">
  <div class="admin-card">
    <div class="reminder-card">
      <div>
        <h2>Reminders</h2>
        <p class="muted">
          Send WhatsApp/SMS/Email about orders. Include customers or custom recipients.
        </p>
      </div>
      <div class="reminder-form">
        <label class="field">
          <span class="muted">Subject</span>
          <input type="text" [(ngModel)]="reminder.subject" placeholder="Subject" />
        </label>
        <label class="field">
          <span class="muted">Message</span>
          <textarea rows="2" [(ngModel)]="reminder.message" placeholder="Message body"></textarea>
        </label>
        <label class="field">
          <span class="muted">Emails (comma or newline)</span>
          <textarea
            rows="2"
            [(ngModel)]="reminder.emails"
            placeholder="a@b.com, c@d.com"
          ></textarea>
        </label>
        <label class="field">
          <span class="muted">Phones (comma or newline, E.164)</span>
          <textarea rows="2" [(ngModel)]="reminder.phones" placeholder="+1..."></textarea>
        </label>
        <label class="field checkbox-field inline-checkbox">
          <input type="checkbox" [(ngModel)]="reminder.includeAllCustomers" />
          <span>Include all customer emails</span>
        </label>
        <div class="channels">
          <label class="field checkbox-field">
            <input type="checkbox" [(ngModel)]="reminder.sendEmail" />
            <span>Email</span>
          </label>
          <label class="field checkbox-field">
            <input type="checkbox" [(ngModel)]="reminder.sendSms" />
            <span>SMS</span>
          </label>
          <label class="field checkbox-field">
            <input type="checkbox" [(ngModel)]="reminder.sendWhatsapp" />
            <span>WhatsApp</span>
          </label>
        </div>
        <div class="actions left">
          <button class="btn primary" type="button" (click)="sendReminder()">Send reminder</button>
        </div>
      </div>
      @if (reminderStatus) {
      <p
        class="status"
        [class.error]="reminderStatus.startsWith('Failed')"
        [class.info]="reminderStatus === 'Sending…'"
      >
        {{ reminderStatus }}
      </p>
      }
    </div>

    <div class="comm-layout">
      <aside class="thread-list">
        <div class="list-header">
          <div class="title">
            <h2>Threads</h2>
            <span class="badge">{{ threads().length }}</span>
          </div>
          <div class="list-actions">
            <button class="btn ghost" type="button" (click)="openCompose()">Send email</button>
            <button class="icon-btn" type="button" (click)="refresh()">↻</button>
          </div>
        </div>
        <div class="filters">
          <label>
            <span class="muted">Type</span>
            <select [(ngModel)]="typeFilter">
              <option value="ALL">All</option>
              <option value="CUSTOMER">Customer</option>
              <option value="VENDOR">Vendor</option>
            </select>
          </label>
          <label>
            <span class="muted">Status</span>
            <select [(ngModel)]="statusFilter">
              <option value="ALL">All</option>
              <option value="OPEN">Open</option>
              <option value="PENDING">Pending</option>
              <option value="RESPONDED">Responded</option>
              <option value="CLOSED">Closed</option>
            </select>
          </label>
        </div>
        @if (loading()) {
        <div class="placeholder">Loading threads…</div>
        } @else if (!threads().length) {
        <div class="placeholder muted">No threads yet.</div>
        } @else { @for (thread of filteredThreads(); track thread.id) {
        <button
          type="button"
          class="thread-item"
          [class.active]="thread.id === selectedThreadId()"
          (click)="selectThread(thread.id)"
        >
          <div class="thread-top">
            <span class="subject">{{ thread.subject }}</span>
            <span
              class="status"
              [class.open]="thread.status === 'open'"
              [class.pending]="thread.status === 'pending'"
              [class.closed]="thread.status === 'closed'"
            >
              {{ thread.status | titlecase }}
            </span>
          </div>
          <div class="thread-meta">
            <span>{{ participants(thread)[0] || 'N/A' }}</span>
            <span class="preview">{{ preview(thread) }}</span>
          </div>
        </button>
        } }
      </aside>

      <section class="thread-view">
        @if (threadForDisplay(); as thread) {
        <header class="thread-header">
          <div>
            <p class="eyebrow">Conversation</p>
            <h2>{{ thread.subject }}</h2>
            <div class="participants">With: {{ participants(thread).join(', ') }}</div>
          </div>
        </header>
        <div class="messages">
          @for (msg of thread.messages; track msg.id) {
          <div class="message" [class.outbound]="msg.direction === 'outbound'">
            <div class="meta">
              <span class="from">{{ msg.from }}</span>
              <span class="time">{{ msg.createdAt | date : 'short' }}</span>
            </div>
            <div class="body">{{ msg.body }}</div>
          </div>
          }
        </div>
        <div class="reply">
          <label class="field">
            <span>Reply</span>
            <textarea rows="3" [(ngModel)]="replyBody" placeholder="Write your reply..."></textarea>
          </label>
          <div class="actions">
            <button class="btn primary" type="button" (click)="sendReply()">Send</button>
          </div>
        </div>
        } @else {
        <div class="empty-state">
          <p>Select a thread to view the conversation.</p>
        </div>
        }
      </section>
    </div>
  </div>
</div>

@if (showCompose) {
<div class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3>Send email</h3>
      <button class="icon-btn" type="button" (click)="closeCompose()">✕</button>
    </div>
    <div class="form-flex">
      <label class="field">
        <span class="muted">To</span>
        <input type="email" [(ngModel)]="compose.to" placeholder="recipient@example.com" />
      </label>
      <label class="field">
        <span class="muted">Subject</span>
        <input type="text" [(ngModel)]="compose.subject" placeholder="Subject" />
      </label>
      <label class="field">
        <span class="muted">Message</span>
        <textarea rows="4" [(ngModel)]="compose.body" placeholder="Write your email..."></textarea>
      </label>
    </div>

    <div class="actions">
      <button class="btn primary" type="button" (click)="sendVendor()">Send</button>
      <button class="btn ghost" type="button" (click)="closeCompose()">Cancel</button>
    </div>
    @if (composeError) {
    <p class="status error">{{ composeError }}</p>
    }
  </div>
</div>
}
