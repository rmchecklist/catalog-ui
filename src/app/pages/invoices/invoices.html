<div class="admin-layout">
  <div class="admin-card invoices-card">
    <div class="header">
      <div>
        <h1>Invoices & Quotes</h1>
        <p class="muted">Review all orders and quotes with quick access to view/download.</p>
      </div>
      <button class="btn ghost" type="button" (click)="load()" [disabled]="loading()">
        Refresh
      </button>
    </div>
    @if (loading()) {
    <p class="muted">Loading...</p>
    } @else if (!invoices().length) {
    <p class="muted">No invoices yet.</p>
    } @else {
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Invoice</th>
            <th>Type</th>
            <th>Status</th>
            <th>Customer</th>
            <th>Email</th>
            <th>Created</th>
            <th>Links</th>
            <th>Send Email</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (inv of invoices(); track inv.id) {
          <tr>
            <td>
              <div class="inv-num">{{ inv.invoiceNumber }}</div>
            </td>
            <td>
              <span class="pill" [class.quote]="inv.type === 'QUOTE'">{{ inv.type }}</span>
            </td>
            <td>{{ inv.status }}</td>
            <td>{{ inv.customerCode }}</td>
            <td>{{ inv.email }}</td>
            <td>{{ inv.createdAt | date : 'short' }}</td>
            <td class="links">
              <a [href]="inv.viewUrl" target="_blank" rel="noreferrer">View</a>
              @if (inv.pdfUrl) { <a [href]="inv.pdfUrl" target="_blank" rel="noreferrer">PDF</a> }
            </td>

            <td>
              <div class="resend">
                <input
                  type="email"
                  placeholder="email"
                  [ngModel]="getEmail(inv)"
                  (ngModelChange)="updateEmail(inv.id, $event)"
                  [attr.aria-label]="'Send to email'"
                />
                <button class="btn ghost" type="button" (click)="resend(inv)">Send</button>
              </div>
            </td>
            <td class="links">
              <button class="link-btn" type="button" (click)="deleteInvoice(inv)">Delete</button>
              <button
                class="link-btn"
                type="button"
                (click)="openEdit(inv)"
                [disabled]="isFinal(inv.status)"
              >
                Edit
              </button>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    } @if (actionError) {
    <p class="status error">{{ actionError }}</p>
    }
  </div>

  @if (editingOpen()) {
  <div class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div>
          <h2>Edit {{ editing?.invoiceNumber }}</h2>
          <p class="muted">{{ editing?.type }}</p>
        </div>
        <button class="icon-btn" type="button" (click)="closeEdit()">✕</button>
      </div>

      <label class="field">
        <span class="field-label">Status</span>
        <select class="fancy-select" [(ngModel)]="editing!.status" [disabled]="!editable">
          @for (s of statuses; track s) {
          <option [value]="s">{{ s }}</option>
          }
        </select>
      </label>

      <div class="items-section">
        <div class="section-header">
          <h3>Line items</h3>
          <button class="btn small" type="button" (click)="addItem()" [disabled]="!editable">
            Add item
          </button>
        </div>
        @if (editing?.items?.length) {
        <div class="items-grid">
          @for (item of editing!.items; let i = $index; track i) {
          <div class="item-row">
            <div class="product-search">
              <input
                type="text"
                placeholder="Search product"
                [ngModel]="productSearch[i] ?? item.productName"
                (ngModelChange)="searchProduct(i, $event)"
                [disabled]="!editable"
              />
              @if (productSuggestions[i]?.length && editable) {
              <div class="suggestions">
                @for (p of productSuggestions[i]; track p.slug) {
                <button type="button" (click)="selectProduct(i, p)">{{ p.name }}</button>
                }
              </div>
              }
            </div>
            <select
              class="fancy-select"
              [ngModel]="item.optionLabel"
              (ngModelChange)="applyOption(i, $event)"
              [disabled]="!editable || !(productOptions[i]?.length)"
            >
              <option value="">Select option</option>
              @for (opt of productOptions[i]; track opt.label) {
              <option [value]="opt.label">{{ opt.label }}</option>
              }
            </select>
            <input type="text" placeholder="SKU" [(ngModel)]="item.sku" [disabled]="!editable" />
            <input
              type="number"
              min="1"
              placeholder="Qty"
              [(ngModel)]="item.quantity"
              [disabled]="!editable"
            />
            <input
              type="number"
              step="0.01"
              placeholder="Price"
              [(ngModel)]="item.sellingPrice"
              [disabled]="!editable"
            />
            <input
              type="number"
              step="0.01"
              placeholder="Market price"
              [(ngModel)]="item.marketPrice"
              [disabled]="!editable"
            />
            <button class="icon-btn" type="button" (click)="removeItem(i)" [disabled]="!editable">
              ✕
            </button>
          </div>
          }
        </div>
        } @else {
        <p class="muted">No items yet.</p>
        }
      </div>

      <div class="totals">
        <div class="muted">Invoice total</div>
        <div class="total-amount">{{ totalAmount() | currency }}</div>
      </div>

      @if (formError) { <p class="status error">{{ formError }}</p> }
      @if (actionError) { <p class="status error">{{ actionError }}</p> }

      <div class="actions">
        <button class="btn primary" type="button" (click)="saveEdit()" [disabled]="!editable">
          Save
        </button>
        <button class="btn ghost" type="button" (click)="closeEdit()">Cancel</button>
      </div>

      @if (history?.length) {
      <div class="history-section">
        <h3>Status history</h3>
        <ul class="history-list">
          @for (h of history; track h.changedAt) {
          <li>
            <span class="pill">{{ h.status }}</span>
            <span class="muted">{{ h.changedAt | date : 'short' }}</span>
          </li>
          }
        </ul>
      </div>
      }
    </div>
  </div>
  }
</div>
